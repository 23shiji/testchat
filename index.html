<htm>
    <head>
        <meta charset="utf-8"/>
        <title>Test Chat</title>
        <script src="https://cdn.bootcss.com/vue/2.5.17-beta.0/vue.js"></script>
        <!-- <script src="//cdn1.lncld.net/static/js/3.7.2/av-min.js"></script> -->
        <script src="//cdn1.lncld.net/static/js/3.7.2/av-live-query-min.js"></script>
        <script src="https://cdn.bootcss.com/js-sha256/0.9.0/sha256.js"></script>
    </head>
    <body>
        <div id="app">
            <div v-if="user_info">
                <h3>你好, {{user_info.attributes.username}}</h3>
                <p>
                    <input v-model="content" @keydown.enter="send_message" type="text"/>
                    <button @click="send_message">发送</button> 
                </p>
                <p v-for="m in messages">
                    <b>{{m.username}}: </b><span>{{m.content}}</span>
                </p>
            </div>
            <div v-else>
                <input type="text" v-model="username" /><br/>
                <input type="password" v-model="password" /><br/>
                <button @click="create_user(username, password)">注册</button>
                <button @click="login(username, password)">登录</button>
                <br/>
            </div>
        </div>
        <script>
            const vm = new Vue({
                el: "#app",
                data: {
                    username: '',
                    password: '',
                    content: '',
                    messages: [],
                    user_info: null
                },
                methods: {
                    create_user(username, password){
                        let user = new AV.User()
                        user.setUsername(username)
                        user.setPassword(password)
                        user.signUp()
                            .then((user) => {
                                this.user_info = user
                                this.init_messages()
                            }).catch( (user, error) => {
                                alert("创建失败: "+error.message)
                            })
                    },
                    login(username, password){
                        AV.User.logIn(username, password)
                            .then((user) => {
                                console.log(user)
                                this.user_info = user
                                this.init_messages()
                                this.init_messages()
                                this.subscribe()
                            }).catch((user, error) => {
                                alert("登录失败: "+error.message)
                            })
                    },
                    send_message(){
                        const DemoChat = AV.Object.extend({
                            className: "TestMessage"
                        })
                        let msg = new DemoChat()
                        msg.set("user", this.user_info._toPointer())
                        msg.set("content", this.content)
                        msg.save()
                        .then((msg) => {
                            this.content = ''
                            // this.messages.unshift({
                            //     username: this.user_info.attributes.username,
                            //     content: msg.attributes.content
                            // })
                        }).catch((error) => {
                            console.error(error)
                                alert("发送失败了")
                        })
                    },
                    subscribe(){
                        let query = new AV.Query('TestMessage')
                        query.subscribe().then((liveQuery) => {
                            liveQuery.on('create', (msg) => {
                                msg.fetch({
                                    include: ["user"]
                                }).then((msg) => {
                                    this.messages.unshift({
                                        username: msg.get("user").get("username"),
                                        content: msg.get("content")
                                    })
                                })  
                            })
                        })
                    },
                    init_messages(){
                        let query = new AV.Query('TestMessage')
                        query.include("user.username")
                        query.lessThanOrEqualTo("createdAt", new Date())
                        query.limit(50)
                        query.find()
                        .then((messages) => {
                            this.messages = messages.map(m => ({
                                username: m.attributes.user.attributes.username,
                                content:  m.attributes.content
                            })).reverse()
                            console.log(this.messages)
                        }).catch((error) => {
                            console.error(error)
                            alert("网络已断，没救了，刷新吧")
                        })
                        this.subscribe()
                    }
                },
                created(){
                    // const APP_ID = "2bf247ad-5ccd-42e6-b695-841c4ff11fb3"
                    // const CLIENT_KEY = "Va4M2Dwl2E6dFHXNGkivdDDeGQZGbAw0"
                    // AV.serverURL = 'https://AV.buddy.com/AV'
                    // AV.initialize(APP_ID, CLIENT_KEY)

                    // const APP_ID = "UqV9GJEedAOz6iSxgtn9AzOG6sJjW0sBJwh27D9N"
                    // const CLIENT_KEY = "p2MivomLHK5FPInBVVigT20CB8gmPGATwZcxKnPk"
                    // AV.serverURL = 'https://parseapi.back4app.com/'
                    // AV.initialize(APP_ID, CLIENT_KEY)

                    const APP_ID = "xpTHT125IoWveEQ4cYi8qf52-MdYXbMMI"
                    const CLIENT_KEY = "OnbuOgk8HfQFXNavO6JhKtha"
                    AV.initialize(APP_ID, CLIENT_KEY)

                    this.user_info = AV.User.current()
                    if(this.user_info){
                        this.init_messages()
                    }
                }
            })
        </script>
    </body>
</htm>